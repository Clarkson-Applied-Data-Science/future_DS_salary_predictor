---
title: "R Notebook"
output: html_notebook
---
```{r echo=FALSE}
library(readr)
library(tidyverse)
library(ggplot2)
library(scales)
library(emmeans)
library(broom) 
library(multcompView)
library(multcomp) 
library(Metrics)
library(caret)
library(dplyr)
library(FSA)


``` 

```{r}
salary_data_no_category <- read.csv("Data/datascience.csv")
salary_data_with_category <- read.csv("Data/datascienceold.csv")  
```

#Left join with salary_data_no_category to impute the job_category
```{r}
category_counts <- salary_data_with_category %>%
  group_by(job_title, job_category) %>%
  tally() %>%
  arrange(job_title, desc(n)) %>%
  group_by(job_title) %>%
  slice(1) %>%
  ungroup()

salary_data_not_split <- salary_data_no_category %>%
  left_join(category_counts %>% dplyr::select(job_title, job_category), by = "job_title") %>%
  mutate(job_category = ifelse(is.na(job_category), "Unknown", job_category))  
#view(salary_data)
```

#Pre-process factoring and scaling
```{r}  
salary_data_not_split <- salary_data_not_split %>%
  mutate(scaled_salary = as.vector(scale(salary_in_usd)))

#removing any job entries outside the US
salary_data_not_split <- salary_data_not_split %>%
  filter(company_location == "US")  

salary_data_not_split <- subset(salary_data_not_split, select = - c(company_location,employee_residence ))

salary_data_not_split$work_year <- as.factor(salary_data_not_split$work_year)
salary_data_not_split$experience_level <- as.factor(salary_data_not_split$experience_level)
salary_data_not_split$employment_type <- as.factor(salary_data_not_split$employment_type)
salary_data_not_split$job_title <- as.factor(salary_data_not_split$job_title)
salary_data_not_split$salary_currency <- as.factor(salary_data_not_split$salary_currency) 
salary_data_not_split$remote_ratio <- as.factor(salary_data_not_split$remote_ratio) 
salary_data_not_split$company_size <- as.factor(salary_data_not_split$company_size)
salary_data_not_split$job_category <- as.factor(salary_data_not_split$job_category) 
```

```{r} 
salary_data_cor <- salary_data_not_split
salary_data_cor$work_year <- as.numeric(salary_data_not_split$work_year)
salary_data_cor$experience_level <- as.numeric(salary_data_not_split$experience_level)
salary_data_cor$employment_type <- as.numeric(salary_data_not_split$employment_type)
salary_data_cor$job_title <- as.numeric(salary_data_not_split$job_title)
salary_data_cor$salary_currency <- as.numeric(salary_data_not_split$salary_currency)
salary_data_cor$remote_ratio <- as.numeric(salary_data_not_split$remote_ratio) 
salary_data_cor$company_size <- as.numeric(salary_data_not_split$company_size)
salary_data_cor$job_category <- as.numeric(salary_data_not_split$job_category)

# Now, calculate the correlation matrix including the encoded variables
cor_matrix <- cor(salary_data_cor, use = "complete.obs", method = "pearson")
print(cor_matrix) 
```

```{r}
# Ensure salary is numeric
salary_data_not_split$salary <- as.numeric(salary_data_not_split$salary)

# Remove columns with only one unique value (no variance)
salary_data_not_split <- salary_data_not_split[, sapply(salary_data_not_split, function(x) length(unique(x)) > 1)]

# Identify non-numeric columns (for factors)
non_numeric_cols <- sapply(salary_data_not_split, function(x) !is.numeric(x))

# Convert them to factors
salary_data_not_split[non_numeric_cols] <- lapply(salary_data_not_split[non_numeric_cols], as.factor)

# Now get the column names of factors
factor_names <- names(salary_data_not_split)[non_numeric_cols]

# If no factors are left, we can't do ANOVA/Kruskal
if (length(factor_names) == 0) {
  stop("No valid categorical variables (factors) to compare against salary.")
}

# Create formula dynamically
formula_str <- paste("salary ~", paste(factor_names, collapse = " + "))
kruskal_formula <- as.formula(formula_str)

# Use Kruskal-Wallis instead of aov
# NOTE: kruskal.test only accepts one factor at a time, so loop if needed
 
results_list <- lapply(factor_names, function(factor_var) {
  test <- kruskal.test(as.formula(paste("salary ~", factor_var)), data = salary_data_not_split)
  data.frame(
    Factor = factor_var,
    Statistic = round(test$statistic, 3),
    P_Value = round(test$p.value, 4),
    stringsAsFactors = FALSE
  )
})

# Combine into a single table
results_table <- do.call(rbind, results_list)

# View the result
print(results_table)
```
All your factors have very low p-values (p < 0.001), which means they have statistically significant effects on salary. Especially job_title, job_category, and experience_level they have huge test statistics, meaning there's a strong difference in salary across their groups.

#Comparision between job roles and the salary
```{r}
top_jobs <- names(sort(table(salary_data_not_split$job_title), decreasing = TRUE)[1:10])
filtered_data <- salary_data_not_split[salary_data_not_split$job_title %in% top_jobs, ]

dunn_result <- dunnTest(salary ~ job_title, data = filtered_data, method = "bonferroni")

print(dunn_result) 
```


there are statistically significant differences in salary between at least some job titles.

#Do the model
```{r}
#source("RandomForest/Model.R")
#source("DecisionTree/Model.R")
source("./LinearRegression/Model.R")
```

#Test the model
```{r}
test_data$predicted_salary <- predict(model, newdata = test_data)
head(test_data[, c("job_title", "salary", "predicted_salary")])
```


